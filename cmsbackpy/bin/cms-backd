#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
sys.path.insert(0, "/opt/cms/lib/python3/site-packages/")

import os, socket
from cms.socket import *

sdsock = socket.socket(socket.AF_UNIX, socket.SOCK_DGRAM)
sdsock.connect(os.getenv("NOTIFY_SOCKET"))

fd = 3
backsock = socket.fromfd(fd, socket.AF_UNIX, socket.SOCK_STREAM)
#backsock.bind("/run/cms-backd.sock")

sdsock.sendall(b"READY=1")
del sdsock

while True:
    conn, addr = backsock.accept()
    msg = recv_message(conn, MAGIC_BACK)
    assert_is_msg(msg, (MsgGet, MsgPost))
    if isinstance(msg, MsgGet):
        print("GET")
        pass#TODO
    elif isinstance(msg, MsgPost):
        print("POST")
        pass#TODO
    else:
        assert False

# vim: ts=4 sw=4 expandtab
